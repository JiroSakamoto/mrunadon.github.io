---
layout: post
title: 『ラブライブ！サンシャイン！！』 の手作り料理<br />世間が最も関心を寄せたのは・・・<br />シャイ煮？ヨキソバ？堕天使の涙？
---
<font size="2">author: Unadon (見習い飯炊き兵)</font>

<font size="2">動作環境:Mac OS Sierra 10.12.1; R　version３.３.１; rstan 2.10.1</font>

＜本稿のねらい＞
・GoogleTrends　のスクレイピングが出来るようになる

・そのデータをStanに渡してGaussian平均の推定が出来るようになる。

・ゼロ過剰ポアソン分布でも、GoogleTrendデータが扱えるようになる。
　　
## 研究の背景
<font size="2">動作環境:Mac OS Sierra 10.12.1; R　version３.３.１; rstan 2.10.1</font>

本稿はStanアドベントカレンダー２０１６へのエントリーです。

<A Href="http://qiita.com/advent-calendar/2016/stan">http://qiita.com/advent-calendar/2016/stan</A>

さて、Stanユーザーのみなさまは、『ラブライブ！サンシャイン！！』というアニメーション作品をご存知でしょうか。

絶大な人気を誇るアニメシリーズ「ラブライブ！」の続編作品であり、このアニメの放映により、

舞台である静岡県沼津市に革命的ともいえる現象が起こっています。

[![](http://img.youtube.com/vi/hipdIQmjj9Y/0.jpg)](https://www.youtube.com/watch?v=hipdIQmjj9Y)

ーーー以前はもみじマーク車ばかり・・・　今は、一体何が走ってんねん・・・きになりますね。

　　

そんな大人気アニメの本編　第１０話では、
ヒロインたちが海の家で手作り料理を売り出します。
まずは、本編に登場した３つの料理をご紹介しましょう。

<font size="2">本稿内容の紹介に必要最低限な範囲で使用するものとして、画像を利用させていただきます。</font>

(A)シャイ煮: 高級食材の洋風煮込み

<img width="300" alt="Shini 2.png" src="https://qiita-image-store.s3.amazonaws.com/0/151938/13183e96-0374-3987-99fc-2bf42eae9aa9.png">

(B)ヨキソバ：　定番オムそば

<img width="300" alt="YokiSoba.png" src="https://qiita-image-store.s3.amazonaws.com/0/151938/2767a5a7-96be-3a42-724d-aba2905980bb.png">

(C)堕天使の涙：　呪術的なたこ焼き

<img width="300" alt="Datenshi_no_Namida.png" src="https://qiita-image-store.s3.amazonaws.com/0/151938/2ed0d744-0267-f807-623e-5156ab6b7ff5.png">


### 研究の目的

これらの料理、アニメファンにとっては「ぜひとも一度食べてみたい！夢の料理」であることとおもいます。なにせ、ヒロインたちの手作りですからね。

ところで、ヨキソバ、堕天使の涙、シャイ煮って、どれが最も世間的な注目を集めたのでしょうか。

本研究の目的は「一番人気の料理はどれか？」「その料理は、他の料理に比べてどれくらい注目を集めたのか！？」を検証することとします。

もちろん、ベイズ統計、stanをつかって検証していきます。

私は洋食が好きなので、『シャイ煮』を応援していきたいところです。

それでは、聖地沼津の巡礼者獲得戦略に役立たんことを祈って、


<CENTER> 
データ分析　スタートです！　　
</CENTER>　


## 方法1 : Scraping

まずは、Google Trendsで検索したときの、「キーワードの人気度」をスクレイピングする準備です。
以下のサイトを参照させていただきました。使用パッケージは”gtrendsR”。インストールしましょう。

<A Href="https://www.karada-good.net/analyticsr/r-392/">https://www.karada-good.net/analyticsr/r-392/N</A>

あわせて、stanやデータ成形用パッケージも読み込んでおきます。


```
library(rstan) 
library(gtrendsR) # Scraping Google Trends
library(ggplot2) 
library(reshape2) 
library(stringi)
library(stringr)
```

続いて、gtrendsRを用いて、RからGoogleTrendsにアクセスして検索をかけ、データを引っ張ってきます。

皆様のGoogleアカウントアドレスとパスワード、さらには検索キーワードを下記のコード内に入れて実行してください。

<font size="2">(パスワードを含んだコードをクローンしないよう気をつけてくださいね。あとで面倒です。)</font>

```
#グーグルアカウントの "メール" と"パスワード"を入力
usr = " " #mail adress
psw = " " # PassWord

# 検索キーワードを設定
keyWords<-c("シャイ煮", "ヨキソバ", "堕天使の涙")

# データ取得期間の設定。機関3ヶ月未満だと日毎のデータ、それ以上は週ごとになってしまう
startDate = c("2016-08-01") #アニメ放送3週間くらい前、たぶん 
endDate = c("2016-11-01") #今回は３ヶ月間の情報を取得


#login
gconnect(usr, psw)


#Scraping with gtrends
GetTrend = gtrends(query = stri_encode(keyWords, "", "utf-8"), 
                    geo = "JP", # get data of "Japan Regions: JP"
                    start_date = startDate, 
                    end_date = endDate
)

# ggplot2-------------------------------------------
Dat = as.data.frame(GetTrend$trend)
ggplot(Dat, aes(x = start, y = hits, colour = keyword))+
  theme_set(theme_gray(base_family="HiraKakuProN-W3"))+ 
  geom_line(size = 1.0) +labs(colour = "検索ワード", x = "日付（月）", y = "検索人気度", title = GetTrend$meta) 

```
  
  
このような感じでデータを取り出してくることができました。

本稿では、"Plotly"で可視化してます。ライン上にカーソルをあわせて、データがどんなもんかご確認ください。
　　
<iframe width="800" height="400" frameborder="0" scrolling="no" src="//plot.ly/~JiroSakamoto/5.embed"></iframe>


## 方法２ : 正規分布による平均の推定　Stanで。

さて、上記データから、"それぞれの人気度平均"を求めていきたいと思います。

まずは、３つの料理それぞれの人気度が正規分布に従うと仮定して、人気度平均を求めてみます。
平均パラメータμには、それぞれの料理の名前をとりました。

```
# Data Reshaping----------------------------------------------------
#上の検索結果Datから、料理別でヒット数を抜いてくる
Shini = Dat$hits[1:c(length(Dat$hits)/3)]
Datenshi = Dat$hits[c(length(Dat$hits)/3+1):c(length(Dat$hits)/3*2)]
Yoki = Dat$hits[2*c(length(Dat$hits)/3+1):c(length(Dat$hits))]
N = c(length(Dat$hits)/3)


#For Stan----------------------------------------------------------
#shini, datenshi, yokiをそれぞれGaussian平均パラメータとする
parameters<- c("shini","datenshi","yoki","sigma")

# 各料理の検索人気は[0,100]の整数データ。Nは料理別での取得データ数。
#これをStanに渡すデータとする。
datastan=list(Shini=Shini,Datenshi=Datenshi,Yoki=Yoki,N=N)

#Gaussian Means
model = '
data {
int N;
int Shini[N];
int Datenshi[N];
int Yoki[N];
}

parameters{
real <lower=0, upper=100>shini;
real <lower=0, upper=100>datenshi;
real <lower=0, upper=100>yoki;
vector <lower=0>[3]sigma;

}

model {
//Gaussian means and SD
shini ~ normal(0, 10);
datenshi ~ normal(0, 10);
yoki ~ normal(0, 10);
sigma ~ cauchy(0,5);

//Mean Estimation
for(i in 1:N){
Shini[i] ~ normal(shini, sigma[1]); 
Datenshi[i] ~ normal(datenshi, sigma[2]); 
Yoki[i] ~ normal(yoki, sigma[3]); 
}

}

'

#Stanfit
fit = stan(model_code = model,data=datastan,pars = parameters)

```

<CENTER>(´Д｀)ﾊｧﾊｧ　</CENTER>

<font size="2">（・・・Stanすると(´Д｀)ﾊｧﾊｧっていうの、どなたが最初に言い始めたものなのでしょうか・・・きになります）</font>

でました。推定結果です。

正規分布を仮定した際の、検索人気度の平均および標準偏差は以下の通り。

```
> print(summary(fit)$summary[,c(1,4,8,9,10)])
                mean         2.5%       97.5%    n_eff      Rhat
shini       6.227136    3.6407266    8.782404 3073.287 1.0000258
datenshi    1.559253    1.1659848    1.950266 3578.117 0.9997438
yoki        1.337652    0.7643921    1.913707 3447.389 1.0004679
sigma[1]   12.570849   10.8442216   14.720791 3664.980 1.0001956
sigma[2]    1.873462    1.6191177    2.168589 3661.752 0.9998802
sigma[3]    2.784135    2.4101546    3.214992 3619.665 1.0000360
lp__     -514.656912 -519.2933259 -512.101014 2062.016 1.0005966
> 
```

Plotして見てみましょう。

```
#extract MCMC samples
d.ext = as.data.frame(extract(fit,permuted=T))
shini = d.ext$shini[1:4000]
datenshi<-d.ext$datenshi[1:4000]
yoki = d.ext$yoki[1:4000]

#result Plot 
extData<-data.frame(shini=shini,datenshi=datenshi,yoki=yoki)
extDf<-melt(extData,id=c(),variable.name = "Dishes")
extDf$value<-as.numeric(extDf$value)
ggplot(data=extDf, aes(x=value, fill=Dishes)) + geom_density(alpha=0.4,position = "identity")
```

<iframe width="800" height="400" frameborder="0" scrolling="no" src="//plot.ly/~JiroSakamoto/11.embed"></iframe>

この結果をみると、ヨキソバと堕天使の涙より、シャイ煮のほうが注目を集めていたということがわかりますね。




## 方法３ : ゼロ過剰ポアソン分布のポアソンの部分で人気度平均を推定　Stanで。

<CENTER>
いやぁ、シャイ煮は強いですね。
</CENTER>

しかし、ちょっとまった。

今回採用したデータをよくよく見てみますと、検索人気度ゼロの日が結構多いことがわかります。

<iframe width="800" height="400" frameborder="0" scrolling="no" src="//plot.ly/~JiroSakamoto/7.embed"></iframe>


ゼロが多いと、ガウス分布の平均は、当然の事ながらゼロの値に大きな影響を受けます。

悲しいかな、ヒロインたちの手作り料理をキーワードとした検索は、コンスタントに生起しない事象のようなのです。

さらに、本編放送前のデータが入ってしまっていることもあいまって、このゼロたちの影響はちょっと取り除いて考えたい。

「検索があった時」にどれくらい注目を集めていたのか、を考えることにしましょう。




ここからは、まず「検索があるかないか」をベルヌイで考えた上で、

「検索があった時に　どの程度注目が集まったのか」考えることができる、ゼロ過剰ポアソン分布で人気度を推定していきたいと思います。

具体的には、「検索があった日」に、「平均的にどの程度の人気度があったのか」を、ポワソン分布の平均パラメータの推定で求めていきます。

平均と分散が等しいという強い仮定をもつポアソン分布なので、
上記のヒストグラムを見る限り、『シャイ煮』の推定人気度が高めに見積もられることは、避けられませんが・・・（分散が大きいので）

まぁ勉強です。やってみましょう。

各料理のポアソン平均lambdaは、わかりやすいように料理名で示します。

```
#For Stan----------------------------------------------------------
#shini, datenshi, yokiをそれぞれポワソン平均パラメータとする
#vector theta[3]は検索が”ゼロ”の確率。
parameters<- c("shini","datenshi","yoki","theta")

# 各料理の検索人気は[0,100]のデータ。Nは料理別での取得データ数。
#これをStanに渡すデータとする。
datastan=list(Shini=Shini,Datenshi=Datenshi,Yoki=Yoki,N=N)


#zero-inflated poisson estimation model
model<-'
data {
int N;
int Shini[N];
int Datenshi[N];
int Yoki[N];
}

parameters{
real <lower=0, upper=100>shini;
real <lower=0, upper=100>datenshi;
real <lower=0, upper=100>yoki;
vector <lower=0, upper=1>[3]theta;

}

model {
for(i in 1:N){
theta[1] ~ beta(1, 1);
shini ~ uniform(0, 100);
theta[2] ~ beta(1, 1);
datenshi ~ uniform(0, 100);
theta[3] ~ beta(1, 1);
yoki ~ uniform(0, 100);

if (Shini[i] == 0) {
target+=log((1 - theta[1]) + theta[1] * exp(-shini));
} else {
target+=bernoulli_lpmf(1| theta[1])+ poisson_lpmf(Shini[i]|shini);
}

if (Datenshi[i] == 0) {
target+=log((1 - theta[2]) + theta[2] * exp(-datenshi));
} else {
target+=bernoulli_lpmf(1| theta[2])+ poisson_lpmf(Datenshi[i]| datenshi);
}
if (Yoki[i] == 0) {
target+=log((1 - theta[3]) + theta[3] * exp(-yoki));
} else {
target+=bernoulli_lpmf(1| theta[3])+ poisson_lpmf(Yoki[i]|yoki);
}
}
}

'

#Stanfit
fit<- stan(model_code = model,data=datastan,pars=parameters)

```

<CENTER>(´Д｀)ﾊｧﾊｧ</CENTER>

推定結果は以下の通りです。

```
summary(fit)$summary[,c(1,3,4,8,9,10)]
                 mean         sd         2.5%        97.5%    n_eff      Rhat
shini      12.0856004 0.52737078   11.0816635   13.1371042 4000.000 0.9999694
datenshi    4.8478887 0.51793926    3.8739373    5.9322145 4000.000 0.9996232
yoki        5.5778441 0.54960034    4.5694754    6.7142403 4000.000 1.0012081
theta[1]    0.4790877 0.05222771    0.3748396    0.5842598 4000.000 0.9996703
theta[2]    0.2243196 0.04347549    0.1425229    0.3164762 4000.000 0.9998906
theta[3]    0.2232210 0.04297814    0.1440775    0.3101207 4000.000 1.0004407
lp__     -575.2472224 1.84161574 -579.7958529 -572.7937808 2038.715 0.9999780
```


シャイ煮と、他の料理との人気度の差がよりはっきりと推定されたかんじでしょうか。

図でみたいので、プロットしてみましょう。

ゼロ過剰ポワソン推定結果
<iframe width="800" height="400" frameborder="0" scrolling="no" src="//plot.ly/~JiroSakamoto/9.embed"></iframe>



## 結果からの考察

## 正規分布で考えた場合も、ゼロ過剰ポワソンで考えた場合も、シャイ煮の人気度は他の2倍以上あるだろうという結果となりました。

### 95%信用(確信)区間をみても、やはりシャイ煮は他の料理より世間の注目を集めていた、といえそうです。


### 「シャイ煮」を売り出すことで、聖地沼津はさらに盛り上がるのではないでしょうか!?　

どうやら、真面目にシャイ煮を再現して売り出している試みは今のところないようですし・・・（筆者が調べた結果）

高級食材あつめて、リアルに再現して売ってみても面白いとおもいます。


## 議論

さて、Stanユーザーのみなさまともあれば、上記の提案にたいしていくつかの疑問を持たれることと思います。

### Q. まずは、「シャイ煮っていう他の料理とか同名の何かがあるんじゃないの？　検索人気度は、それが混じってたんじゃないの？」というご指摘でしょう。

その点については、、Google検索、フランス料理大辞典ラルース、私が信頼する論文データベースPubMedとGoogleScholarを検索しましたがヒットしませんでしたので、たぶん大丈夫とおもいます。


### Q. 「よく検索されたからといって、『食べたい』と思ってるわけではないんじゃないか？」というご指摘も考えられます。

もしそうなら、確かに売れません。

その点にかんしては、Rパッケージ"TwitteR"により「シャイ煮」をキーワードとした過去の772ツイートをテキストマイニング（共起分析）した結果でお答えいたします。

真面目にデータクリーニングしなかったので、余計なものが混じってますが。

<img width="600" alt="TextMinningResult.png" src="https://mrunadon.github.io/images/TextMinningResult.png">

ラブライブ！ファンのみなさまは、シャイ煮もヨキソバも堕天使の涙も、「食べたいやつはリツイート！！！」と、欲望を拡散している模様でございます。

いかがでしょう。これが日本の現状です。


### Q. 「シャイ煮を売り出したところで、本当に関心を持っているのは一部のファンなんじゃないの？それで売上見込めるの？」という実利的な観点からの疑問を持たれるからもいらっしゃるでしょう。

Google　Trendの地域別検索人気度ランキングを以下に示します。

まずは、ヨキソバと堕天使の涙。

<img width="800" alt="YokiDatenshi.png" src="https://mrunadon.github.io/images/YokiDatenshi.png">


上記の結果は、関東に在住する一部のコアなファンたちからの関心が強いことをうかがわせます。


一方、シャイ煮は・・・といいますと・・・

<img width="600" alt="Shini.png" src="https://mrunadon.github.io/images/Shini.png">

もはや関心は全国区なのであります。


# 結論

## シャイ煮は人気。売ったらいいのに。全国からお客さんくるんじゃない？

以上、Stanをつかったデータ分析の一例でした。

Stanユーザーのみなさまと、聖地沼津が今後さらに盛り上がっていくことを祈って。

Enjoy!!
